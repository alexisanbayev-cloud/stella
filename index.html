<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stella - Dealer Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; }
        .gradient-bg { background: linear-gradient(135deg, #1e3a5f 0%, #2d5a87 100%); }
        .status-production { background: #fef3c7; color: #92400e; }
        .status-ready { background: #d1fae5; color: #065f46; }
        .status-shipped { background: #dbeafe; color: #1e40af; }
        .status-pending { background: #f3f4f6; color: #374151; }
        .cat-active { background: #3b82f6; color: white; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div id="app">
        <div class="min-h-screen gradient-bg flex items-center justify-center p-4">
            <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-8 text-center">
                <div class="text-6xl mb-4">üìä</div>
                <h2 class="text-xl font-bold text-gray-800 mb-2">Loading...</h2>
                <p class="text-gray-500">Connecting to Google Sheets...</p>
            </div>
        </div>
    </div>
    
    <script>
// ============================================
// CONFIGURATION
// ============================================
const CONFIG = {
    SPREADSHEET_ID: '1kQcSiTcmPu1dfbBH9wVEOeYOpgSXlfzbeur8u32373k',
    API_KEY: 'AIzaSyBaJW2t64e9TI3_Xw8-fgo9iB-o37WrBDM',
    SHEETS: {
        DEALERS: 'Dealers',
        PRODUCTS: 'Products', 
        ORDERS: 'Orders',
        ORDER_ITEMS: 'Order Items'
    }
};

// ============================================
// TRANSLATIONS
// ============================================
const T = {
    en: { welcome:"Stella Dealer Portal", login:"Login", dealerCode:"Dealer Code", password:"Password", myOrders:"My Orders", newOrder:"New Order", logout:"Logout", orderNo:"Order #", date:"Date", status:"Status", ready:"Ready Date", total:"Total", details:"Details", noOrders:"No orders yet", pending:"Pending", production:"In Production", readyStatus:"Ready", shipped:"Shipped", selectProducts:"Select Products", cart:"Order Summary", empty:"Cart is empty", submit:"Submit Order", submitted:"Order submitted!", notes:"Notes", back:"Back", items:"Items", qty:"Qty", error:"Invalid credentials", currency:"‚Ç¨", size:"Size", color:"Color/Decor", pcs:"pcs", search:"Search products...", allCategories:"All Products" },
    de: { welcome:"Stella H√§ndlerportal", login:"Anmelden", dealerCode:"H√§ndlercode", password:"Passwort", myOrders:"Bestellungen", newOrder:"Neue Bestellung", logout:"Abmelden", orderNo:"Best.Nr.", date:"Datum", status:"Status", ready:"Fertig", total:"Gesamt", details:"Details", noOrders:"Keine Bestellungen", pending:"Ausstehend", production:"In Produktion", readyStatus:"Fertig", shipped:"Versendet", selectProducts:"Produkte", cart:"√úbersicht", empty:"Warenkorb leer", submit:"Absenden", submitted:"Erfolgreich!", notes:"Notizen", back:"Zur√ºck", items:"Artikel", qty:"Menge", error:"Ung√ºltige Daten", currency:"‚Ç¨", size:"Gr√∂√üe", color:"Farbe/Dekor", pcs:"Stk", search:"Suchen...", allCategories:"Alle Produkte" },
    it: { welcome:"Portale Stella", login:"Accedi", dealerCode:"Codice", password:"Password", myOrders:"Ordini", newOrder:"Nuovo Ordine", logout:"Esci", orderNo:"Ordine", date:"Data", status:"Stato", ready:"Pronto", total:"Totale", details:"Dettagli", noOrders:"Nessun ordine", pending:"In Attesa", production:"In Produzione", readyStatus:"Pronto", shipped:"Spedito", selectProducts:"Prodotti", cart:"Riepilogo", empty:"Carrello vuoto", submit:"Invia", submitted:"Inviato!", notes:"Note", back:"Indietro", items:"Articoli", qty:"Qt√†", error:"Credenziali errate", currency:"‚Ç¨", size:"Misura", color:"Colore", pcs:"pz", search:"Cerca...", allCategories:"Tutti" },
    fr: { welcome:"Portail Stella", login:"Connexion", dealerCode:"Code", password:"Mot de passe", myOrders:"Commandes", newOrder:"Nouvelle", logout:"D√©connexion", orderNo:"N¬∞", date:"Date", status:"Statut", ready:"Pr√™t", total:"Total", details:"D√©tails", noOrders:"Aucune commande", pending:"En Attente", production:"En Production", readyStatus:"Pr√™t", shipped:"Exp√©di√©", selectProducts:"Produits", cart:"R√©sum√©", empty:"Panier vide", submit:"Envoyer", submitted:"Envoy√©!", notes:"Notes", back:"Retour", items:"Articles", qty:"Qt√©", error:"Invalide", currency:"‚Ç¨", size:"Taille", color:"Couleur", pcs:"pcs", search:"Rechercher...", allCategories:"Tous" },
    tr: { welcome:"Stella Bayi Portalƒ±", login:"Giri≈ü", dealerCode:"Bayi Kodu", password:"≈ûifre", myOrders:"Sipari≈üler", newOrder:"Yeni Sipari≈ü", logout:"√áƒ±kƒ±≈ü", orderNo:"Sipari≈ü", date:"Tarih", status:"Durum", ready:"Hazƒ±r", total:"Toplam", details:"Detay", noOrders:"Sipari≈ü yok", pending:"Bekliyor", production:"√úretimde", readyStatus:"Hazƒ±r", shipped:"Sevk Edildi", selectProducts:"√úr√ºnler", cart:"√ñzet", empty:"Sepet bo≈ü", submit:"G√∂nder", submitted:"G√∂nderildi!", notes:"Notlar", back:"Geri", items:"√úr√ºnler", qty:"Adet", error:"Hatalƒ± giri≈ü", currency:"‚Ç¨", size:"Boyut", color:"Renk", pcs:"ad", search:"Ara...", allCategories:"T√ºm√º" },
    el: { welcome:"Œ†œçŒªŒ∑ Stella", login:"Œ£œçŒΩŒ¥ŒµœÉŒ∑", dealerCode:"ŒöœâŒ¥ŒπŒ∫œåœÇ", password:"ŒöœâŒ¥ŒπŒ∫œåœÇ", myOrders:"Œ†Œ±œÅŒ±Œ≥Œ≥ŒµŒªŒØŒµœÇ", newOrder:"ŒùŒ≠Œ±", logout:"ŒàŒæŒøŒ¥ŒøœÇ", orderNo:"ŒëœÅ.", date:"ŒóŒº/ŒΩŒØŒ±", status:"ŒöŒ±œÑŒ¨œÉœÑŒ±œÉŒ∑", ready:"ŒàœÑŒøŒπŒºŒø", total:"Œ£œçŒΩŒøŒªŒø", details:"ŒõŒµœÄœÑŒøŒº.", noOrders:"ŒöŒ±ŒºŒØŒ±", pending:"ŒëŒΩŒ±ŒºŒøŒΩŒÆ", production:"Œ†Œ±œÅŒ±Œ≥œâŒ≥ŒÆ", readyStatus:"ŒàœÑŒøŒπŒºŒø", shipped:"ŒëœÄŒµœÉœÑŒ¨ŒªŒ∑", selectProducts:"Œ†œÅŒøœäœåŒΩœÑŒ±", cart:"Œ£œçŒΩŒøœàŒ∑", empty:"ŒÜŒ¥ŒµŒπŒø", submit:"Œ•œÄŒøŒ≤ŒøŒªŒÆ", submitted:"Œ•œÄŒøŒ≤ŒªŒÆŒ∏Œ∑Œ∫Œµ!", notes:"Œ£Œ∑ŒºŒµŒπœéœÉŒµŒπœÇ", back:"Œ†ŒØœÉœâ", items:"ŒïŒØŒ¥Œ∑", qty:"Œ†ŒøœÉ.", error:"ŒõŒ¨Œ∏ŒøœÇ", currency:"‚Ç¨", size:"ŒúŒ≠Œ≥ŒµŒ∏ŒøœÇ", color:"ŒßœÅœéŒºŒ±", pcs:"œÑŒµŒº", search:"ŒëŒΩŒ±Œ∂ŒÆœÑŒ∑œÉŒ∑...", allCategories:"ŒåŒªŒ±" },
    nl: { welcome:"Stella Portaal", login:"Inloggen", dealerCode:"Code", password:"Wachtwoord", myOrders:"Bestellingen", newOrder:"Nieuw", logout:"Uitloggen", orderNo:"Nr.", date:"Datum", status:"Status", ready:"Gereed", total:"Totaal", details:"Details", noOrders:"Geen", pending:"Wachtend", production:"In Productie", readyStatus:"Gereed", shipped:"Verzonden", selectProducts:"Producten", cart:"Overzicht", empty:"Leeg", submit:"Verzenden", submitted:"Verzonden!", notes:"Notities", back:"Terug", items:"Artikelen", qty:"Aantal", error:"Ongeldig", currency:"‚Ç¨", size:"Maat", color:"Kleur", pcs:"st", search:"Zoeken...", allCategories:"Alles" },
    ro: { welcome:"Portal Stella", login:"Autentificare", dealerCode:"Cod", password:"ParolƒÉ", myOrders:"Comenzi", newOrder:"NouƒÉ", logout:"Ie»ôire", orderNo:"Nr.", date:"Data", status:"Status", ready:"Gata", total:"Total", details:"Detalii", noOrders:"FƒÉrƒÉ", pending:"A»ôteptare", production:"Produc»õie", readyStatus:"Gata", shipped:"Expediat", selectProducts:"Produse", cart:"Sumar", empty:"Gol", submit:"Trimite", submitted:"Trimis!", notes:"Note", back:"√énapoi", items:"Articole", qty:"Cant.", error:"Invalid", currency:"‚Ç¨", size:"MƒÉrime", color:"Culoare", pcs:"buc", search:"CƒÉutare...", allCategories:"Toate" },
    hu: { welcome:"Stella Port√°l", login:"Bel√©p√©s", dealerCode:"K√≥d", password:"Jelsz√≥", myOrders:"Rendel√©sek", newOrder:"√öj", logout:"Kil√©p√©s", orderNo:"Sz.", date:"D√°tum", status:"St√°tusz", ready:"K√©sz", total:"√ñsszesen", details:"R√©szletek", noOrders:"Nincs", pending:"F√ºgg≈ëben", production:"Gy√°rt√°sban", readyStatus:"K√©sz", shipped:"Sz√°ll√≠tva", selectProducts:"Term√©kek", cart:"√ñsszegz√©s", empty:"√úres", submit:"K√ºld√©s", submitted:"Elk√ºldve!", notes:"Megjegyz√©s", back:"Vissza", items:"T√©telek", qty:"Db", error:"Hib√°s", currency:"‚Ç¨", size:"M√©ret", color:"Sz√≠n", pcs:"db", search:"Keres√©s...", allCategories:"√ñsszes" },
    bg: { welcome:"–ü–æ—Ä—Ç–∞–ª Stella", login:"–í—Ö–æ–¥", dealerCode:"–ö–æ–¥", password:"–ü–∞—Ä–æ–ª–∞", myOrders:"–ü–æ—Ä—ä—á–∫–∏", newOrder:"–ù–æ–≤–∞", logout:"–ò–∑—Ö–æ–¥", orderNo:"‚Ññ", date:"–î–∞—Ç–∞", status:"–°—Ç–∞—Ç—É—Å", ready:"–ì–æ—Ç–æ–≤–æ", total:"–û–±—â–æ", details:"–î–µ—Ç–∞–π–ª–∏", noOrders:"–ù—è–º–∞", pending:"–ß–∞–∫–∞—â–∏", production:"–ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ", readyStatus:"–ì–æ—Ç–æ–≤–æ", shipped:"–ò–∑–ø—Ä–∞—Ç–µ–Ω–æ", selectProducts:"–ü—Ä–æ–¥—É–∫—Ç–∏", cart:"–†–µ–∑—é–º–µ", empty:"–ü—Ä–∞–∑–Ω–æ", submit:"–ò–∑–ø—Ä–∞—Ç–∏", submitted:"–ò–∑–ø—Ä–∞—Ç–µ–Ω–æ!", notes:"–ë–µ–ª–µ–∂–∫–∏", back:"–ù–∞–∑–∞–¥", items:"–ê—Ä—Ç–∏–∫—É–ª–∏", qty:"–ë—Ä.", error:"–ì—Ä–µ—à–∫–∞", currency:"‚Ç¨", size:"–†–∞–∑–º–µ—Ä", color:"–¶–≤—è—Ç", pcs:"–±—Ä", search:"–¢—ä—Ä—Å–µ–Ω–µ...", allCategories:"–í—Å–∏—á–∫–∏" }
};

const FLAGS = { en:'üá∫üá∏', de:'üá©üá™', it:'üáÆüáπ', fr:'üá´üá∑', tr:'üáπüá∑', el:'üá¨üá∑', nl:'üá≥üá±', ro:'üá∑üá¥', hu:'üá≠üá∫', bg:'üáßüá¨' };

// ============================================
// DATA
// ============================================
let DATA = { dealers: [], products: [], orders: [], orderItems: [], loaded: false, error: null };

// ============================================
// STATE
// ============================================
let S = { page: 'login', lang: 'en', user: null, cart: [], selOrder: null, submitted: false, category: 'all', search: '' };

const t = k => T[S.lang]?.[k] || T.en[k] || k;
const fmt = n => '‚Ç¨' + parseFloat(n || 0).toLocaleString('de-DE', {minimumFractionDigits: 0, maximumFractionDigits: 0});

// ============================================
// LOAD DATA FROM GOOGLE SHEETS
// ============================================
async function loadData() {
    const baseUrl = `https://sheets.googleapis.com/v4/spreadsheets/${CONFIG.SPREADSHEET_ID}/values`;
    
    try {
        const responses = await Promise.all([
            fetch(`${baseUrl}/${encodeURIComponent(CONFIG.SHEETS.DEALERS)}?key=${CONFIG.API_KEY}`),
            fetch(`${baseUrl}/${encodeURIComponent(CONFIG.SHEETS.PRODUCTS)}?key=${CONFIG.API_KEY}`),
            fetch(`${baseUrl}/${encodeURIComponent(CONFIG.SHEETS.ORDERS)}?key=${CONFIG.API_KEY}`),
            fetch(`${baseUrl}/${encodeURIComponent(CONFIG.SHEETS.ORDER_ITEMS)}?key=${CONFIG.API_KEY}`)
        ]);
        
        const [dealersRes, productsRes, ordersRes, itemsRes] = await Promise.all(responses.map(r => r.json()));
        
        function parse(data) {
            if (!data.values || data.values.length < 2) return [];
            const headers = data.values[0].map(h => h.toString().toLowerCase().replace(/[^a-z0-9]/g, '_'));
            return data.values.slice(1).map(row => {
                const obj = {};
                headers.forEach((h, i) => obj[h] = row[i] || '');
                return obj;
            });
        }
        
        DATA.dealers = parse(dealersRes);
        DATA.products = parse(productsRes);
        DATA.orders = parse(ordersRes);
        DATA.orderItems = parse(itemsRes);
        DATA.loaded = true;
        
        console.log('‚úÖ Data loaded:', DATA);
        render();
        
    } catch (err) {
        console.error('‚ùå Error:', err);
        DATA.error = err.message;
        render();
    }
}

// ============================================
// RENDER
// ============================================
function render() {
    const app = document.getElementById('app');
    
    if (!DATA.loaded && !DATA.error) {
        return; // Still loading
    }
    
    if (DATA.error) {
        app.innerHTML = `
            <div class="min-h-screen gradient-bg flex items-center justify-center p-4">
                <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-8 text-center">
                    <div class="text-6xl mb-4">‚ùå</div>
                    <h2 class="text-xl font-bold text-gray-800 mb-2">Connection Error</h2>
                    <p class="text-gray-500 mb-4">${DATA.error}</p>
                    <button onclick="location.reload()" class="bg-blue-600 text-white px-6 py-2 rounded-lg">Retry</button>
                </div>
            </div>`;
        return;
    }
    
    if (S.page === 'login') app.innerHTML = loginPage();
    else if (S.page === 'orders') app.innerHTML = layout(ordersPage());
    else if (S.page === 'new') app.innerHTML = layout(newOrderPage());
    else if (S.page === 'detail') app.innerHTML = layout(detailPage());
    
    bind();
}

function loginPage() {
    return `
    <div class="min-h-screen gradient-bg flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-8">
            <div class="flex justify-center flex-wrap gap-2 mb-6">
                ${Object.keys(FLAGS).map(l=>`<button onclick="setLang('${l}')" class="w-9 h-9 rounded-full ${S.lang===l?'ring-2 ring-blue-500':''} text-xl hover:scale-110 transition">${FLAGS[l]}</button>`).join('')}
            </div>
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-gray-800 mb-2">STELLA</h1>
                <p class="text-gray-500">${t('welcome')}</p>
                <p class="text-green-500 text-sm mt-2">‚úì Connected to Google Sheets (${DATA.dealers.length} dealers, ${DATA.products.length} products)</p>
            </div>
            <form id="loginForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">${t('dealerCode')}</label>
                    <input type="text" id="code" class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="HEXIM" autofocus>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">${t('password')}</label>
                    <input type="password" id="pass" class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" value="stella2024">
                </div>
                <div id="err" class="hidden text-red-500 text-sm text-center"></div>
                <button type="submit" class="w-full bg-blue-600 text-white py-3 rounded-lg font-medium hover:bg-blue-700 transition">${t('login')}</button>
            </form>
            <div class="mt-4 p-3 bg-gray-50 rounded-lg text-xs text-gray-500">
                <strong>Dealers:</strong> ${DATA.dealers.map(d => d.dealer_code).join(', ')}
            </div>
        </div>
    </div>`;
}

function layout(content) {
    return `
    <div class="min-h-screen bg-gray-50">
        <header class="gradient-bg text-white">
            <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <h1 class="text-2xl font-bold">STELLA</h1>
                    <span class="text-blue-200">|</span>
                    <span class="text-blue-100">${S.user?.company_name || S.user?.dealer_code}</span>
                </div>
                <div class="flex items-center gap-2">
                    ${Object.keys(FLAGS).map(l=>`<button onclick="setLang('${l}')" class="w-7 h-7 rounded ${S.lang===l?'bg-white':'bg-blue-500/30 hover:bg-blue-500/50'} text-sm transition">${FLAGS[l]}</button>`).join('')}
                    <button onclick="logout()" class="ml-3 text-blue-100 hover:text-white text-sm">${t('logout')}</button>
                </div>
            </div>
            <nav class="bg-blue-900/30">
                <div class="max-w-7xl mx-auto px-4 flex gap-1">
                    <button onclick="go('orders')" class="px-6 py-3 text-sm font-medium transition ${S.page==='orders'||S.page==='detail'?'bg-white text-blue-600':'text-blue-100 hover:bg-blue-500/30'}">${t('myOrders')}</button>
                    <button onclick="go('new')" class="px-6 py-3 text-sm font-medium transition ${S.page==='new'?'bg-white text-blue-600':'text-blue-100 hover:bg-blue-500/30'}">${t('newOrder')}</button>
                </div>
            </nav>
        </header>
        <main class="max-w-7xl mx-auto px-4 py-8">${content}</main>
    </div>`;
}

function ordersPage() {
    const orders = DATA.orders.filter(o => o.dealer_code === S.user?.dealer_code);
    
    if (!orders.length) {
        return `<div class="bg-white rounded-xl p-12 text-center text-gray-500">${t('noOrders')}<br><button onclick="go('new')" class="mt-4 bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700">${t('newOrder')}</button></div>`;
    }
    
    const statusCls = s => {
        s = (s||'').toLowerCase();
        return s==='pending'?'status-pending':s==='production'?'status-production':s==='ready'?'status-ready':s==='shipped'?'status-shipped':'status-pending';
    };
    const statusTxt = s => {
        s = (s||'').toLowerCase();
        return s==='pending'?t('pending'):s==='production'?t('production'):s==='ready'?t('readyStatus'):s==='shipped'?t('shipped'):s;
    };
    
    return `<h2 class="text-xl font-semibold mb-6">${t('myOrders')}</h2>
    <div class="space-y-4">
        ${orders.map(o=>`
        <div class="bg-white rounded-xl shadow-sm p-6 hover:shadow-md transition">
            <div class="flex justify-between items-center flex-wrap gap-4">
                <div class="flex gap-6 flex-wrap">
                    <div><p class="text-sm text-gray-500">${t('orderNo')}</p><p class="font-semibold">${o.order_id}</p></div>
                    <div><p class="text-sm text-gray-500">${t('date')}</p><p>${o.order_date}</p></div>
                    <div><p class="text-sm text-gray-500">${t('status')}</p><span class="px-3 py-1 rounded-full text-sm font-medium ${statusCls(o.status)}">${statusTxt(o.status)}</span></div>
                    <div><p class="text-sm text-gray-500">${t('ready')}</p><p class="font-medium">${o.ready_date || '-'}</p></div>
                </div>
                <div class="flex items-center gap-4">
                    <div class="text-right"><p class="text-sm text-gray-500">${t('total')}</p><p class="font-semibold">${fmt(o.total_eur)}</p></div>
                    <button onclick="viewOrder('${o.order_id}')" class="bg-gray-100 px-4 py-2 rounded-lg text-sm hover:bg-gray-200 transition">${t('details')}</button>
                </div>
            </div>
        </div>`).join('')}
    </div>`;
}

function detailPage() {
    const o = DATA.orders.find(x => x.order_id === S.selOrder);
    if (!o) { go('orders'); return ''; }
    
    const items = DATA.orderItems.filter(i => i.order_id === S.selOrder);
    
    const statusCls = s => {
        s = (s||'').toLowerCase();
        return s==='pending'?'status-pending':s==='production'?'status-production':s==='ready'?'status-ready':s==='shipped'?'status-shipped':'status-pending';
    };
    const statusTxt = s => {
        s = (s||'').toLowerCase();
        return s==='pending'?t('pending'):s==='production'?t('production'):s==='ready'?t('readyStatus'):s==='shipped'?t('shipped'):s;
    };
    
    return `
    <button onclick="go('orders')" class="flex items-center gap-2 text-gray-600 hover:text-gray-800 mb-6">‚Üê ${t('back')}</button>
    <div class="bg-white rounded-xl shadow-sm p-6">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-xl font-semibold">${o.order_id}</h2>
            <span class="px-4 py-2 rounded-full font-medium ${statusCls(o.status)}">${statusTxt(o.status)}</span>
        </div>
        <div class="grid grid-cols-3 gap-6 mb-6 p-4 bg-gray-50 rounded-lg">
            <div><p class="text-sm text-gray-500">${t('date')}</p><p class="font-medium">${o.order_date}</p></div>
            <div><p class="text-sm text-gray-500">${t('ready')}</p><p class="font-medium text-blue-600">${o.ready_date || '-'}</p></div>
            <div><p class="text-sm text-gray-500">${t('total')}</p><p class="font-medium">${fmt(o.total_eur)}</p></div>
        </div>
        <h3 class="font-medium mb-4">${t('items')}</h3>
        <div class="overflow-x-auto">
            <table class="w-full border rounded-lg overflow-hidden">
                <thead class="bg-gray-50"><tr>
                    <th class="px-4 py-3 text-left text-sm font-medium">${t('items')}</th>
                    <th class="px-4 py-3 text-sm font-medium">${t('color')}</th>
                    <th class="px-4 py-3 text-sm font-medium">${t('size')}</th>
                    <th class="px-4 py-3 text-sm font-medium">${t('qty')}</th>
                    <th class="px-4 py-3 text-right text-sm font-medium">${t('total')}</th>
                </tr></thead>
                <tbody>${items.map(i=>`<tr class="border-t">
                    <td class="px-4 py-3 font-medium">${i.product_name}</td>
                    <td class="px-4 py-3 text-center text-gray-600">${i.color_decor}</td>
                    <td class="px-4 py-3 text-center text-gray-500 text-sm">${i.size}</td>
                    <td class="px-4 py-3 text-center">${i.quantity}</td>
                    <td class="px-4 py-3 text-right font-medium">${fmt(i.total)}</td>
                </tr>`).join('')}</tbody>
            </table>
        </div>
    </div>`;
}

function newOrderPage() {
    if (S.submitted) {
        return `<div class="bg-white rounded-xl p-12 text-center"><div class="text-green-500 text-5xl mb-4">‚úì</div><h3 class="text-xl font-semibold">${t('submitted')}</h3><button onclick="resetOrder()" class="mt-4 bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700">${t('newOrder')}</button></div>`;
    }
    
    const cartTotal = S.cart.reduce((s, i) => s + i.q * i.pr, 0);
    const categories = ['all', ...new Set(DATA.products.map(p => p.category).filter(Boolean))];
    
    let filtered = DATA.products.filter(p => p.status === 'Active');
    if (S.category !== 'all') filtered = filtered.filter(p => p.category === S.category);
    if (S.search) {
        const q = S.search.toLowerCase();
        filtered = filtered.filter(p => 
            (p.product_name || '').toLowerCase().includes(q) || 
            (p.color_decor || '').toLowerCase().includes(q) ||
            (p.sku || '').toLowerCase().includes(q)
        );
    }
    
    return `
    <div class="grid grid-cols-4 gap-6">
        <div class="col-span-3 space-y-4">
            <div class="flex gap-4 items-center">
                <h2 class="text-xl font-semibold">${t('selectProducts')}</h2>
                <input type="text" id="searchInput" placeholder="${t('search')}" value="${S.search}" 
                    class="flex-1 max-w-md px-4 py-2 border rounded-lg" onkeyup="searchProducts(this.value)">
            </div>
            
            <div class="flex flex-wrap gap-2">
                ${categories.map(c=>`<button onclick="setCat('${c}')" class="px-4 py-2 rounded-lg text-sm font-medium transition ${S.category===c ? 'cat-active' : 'bg-white hover:bg-gray-100'}">${c === 'all' ? t('allCategories') : c}</button>`).join('')}
            </div>
            
            <div class="bg-white rounded-xl shadow-sm p-4">
                ${filtered.length === 0 ? `<p class="text-gray-500 text-center py-8">No products found</p>` : `
                <div class="grid gap-3">
                    ${filtered.map(p=>`
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition">
                        <div class="flex-1">
                            <p class="font-medium text-gray-800">${p.product_name}</p>
                            <p class="text-sm text-gray-500">${p.color_decor} ‚Ä¢ ${p.size__mm_} ‚Ä¢ ${p.pack_quantity} ${p.unit}</p>
                        </div>
                        <div class="flex items-center gap-3">
                            <span class="text-gray-700 font-medium">${fmt(p.price_eur)}</span>
                            <input type="number" id="q-${p.sku}" min="0" value="0" class="w-20 px-3 py-2 border rounded-lg text-center">
                            <button onclick="addCart('${p.sku}')" class="bg-blue-600 text-white w-10 h-10 rounded-lg hover:bg-blue-700 text-xl">+</button>
                        </div>
                    </div>`).join('')}
                </div>`}
            </div>
        </div>
        
        <div>
            <h2 class="text-xl font-semibold mb-4">${t('cart')}</h2>
            <div class="bg-white rounded-xl shadow-sm p-4 sticky top-6">
                ${S.cart.length===0 ? `<p class="text-gray-500 text-center py-8">${t('empty')}</p>` : `
                <div class="space-y-3 mb-4 max-h-96 overflow-y-auto">
                    ${S.cart.map((c,i)=>`
                    <div class="p-3 bg-gray-50 rounded-lg">
                        <div class="flex justify-between items-start">
                            <div class="flex-1 pr-2">
                                <p class="font-medium text-sm">${c.name}</p>
                                <p class="text-xs text-gray-500">${c.color}</p>
                                <p class="text-xs text-gray-400">${c.q} √ó ${fmt(c.pr)}</p>
                            </div>
                            <button onclick="rmCart(${i})" class="text-red-500 hover:text-red-700 text-lg">‚úï</button>
                        </div>
                        <div class="text-right font-medium mt-1">${fmt(c.q*c.pr)}</div>
                    </div>`).join('')}
                </div>
                <div class="border-t pt-4 mb-4 flex justify-between items-center">
                    <span class="font-medium">${t('total')}</span>
                    <span class="text-xl font-bold text-blue-600">${fmt(cartTotal)}</span>
                </div>
                <button onclick="submitOrder()" class="w-full bg-green-600 text-white py-3 rounded-lg font-medium hover:bg-green-700">${t('submit')}</button>
                `}
            </div>
        </div>
    </div>`;
}

// ============================================
// ACTIONS
// ============================================
function setLang(l) { S.lang = l; render(); }
function go(p) { S.page = p; S.submitted = false; S.category = 'all'; S.search = ''; render(); }
function logout() { S = { page: 'login', lang: S.lang, user: null, cart: [], selOrder: null, submitted: false, category: 'all', search: '' }; render(); }
function viewOrder(id) { S.selOrder = id; S.page = 'detail'; render(); }
function setCat(c) { S.category = c; render(); }
function searchProducts(q) { S.search = q; render(); }

function addCart(sku) {
    const p = DATA.products.find(x => x.sku === sku);
    const inp = document.getElementById('q-' + sku);
    const q = parseInt(inp.value) || 0;
    if (q > 0 && p) {
        const ex = S.cart.findIndex(c => c.sku === sku);
        if (ex >= 0) S.cart[ex].q += q;
        else S.cart.push({ sku, name: p.product_name, color: p.color_decor, size: p.size__mm_, pr: parseFloat(p.price_eur) || 0, q });
        inp.value = 0;
        render();
    }
}

function rmCart(i) { S.cart.splice(i, 1); render(); }
function submitOrder() { 
    console.log('üì¶ Order submitted:', { dealer: S.user, items: S.cart, total: S.cart.reduce((s,i)=>s+i.q*i.pr,0) });
    alert('Order submitted! Check console (F12) for details.\n\nTo save orders to Google Sheets, you need a backend server.');
    S.submitted = true; 
    S.cart = []; 
    render(); 
}
function resetOrder() { S.submitted = false; render(); }

function bind() {
    const form = document.getElementById('loginForm');
    if (form) {
        form.onsubmit = e => {
            e.preventDefault();
            const code = document.getElementById('code').value.toUpperCase().trim();
            const pass = document.getElementById('pass').value;
            
            const dealer = DATA.dealers.find(d => d.dealer_code === code);
            
            if (dealer && pass === 'stella2024') {
                S.user = dealer;
                S.lang = dealer.language || 'en';
                S.page = 'orders';
                render();
            } else {
                document.getElementById('err').textContent = t('error') + (dealer ? '' : ' - Dealer not found');
                document.getElementById('err').classList.remove('hidden');
            }
        };
    }
}

// ============================================
// START
// ============================================
loadData();
    </script>
</body>
</html>
